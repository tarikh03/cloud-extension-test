function environmentDirective(){return{restrict:"E",templateUrl:"views/environments/environment.html",scope:{content:"="},controller:function($scope,TDMService,BreadCrumbsService,toastr,SweetAlert,$timeout,AuthService,DTColumnBuilder,DTOptionsBuilder,$q,$compile,$uibModal,$http){this._scope=$scope;var environmentCtrl=this;environmentCtrl.environmentData=$scope.content.environmentData,environmentCtrl.environmentDataOrig=angular.copy(environmentCtrl.environmentData),environmentCtrl.pageDisplay="environment",environmentCtrl.envTypes=["Both","Source","Target"],TDMService.getFabricRoles("owner").then(response=>{environmentCtrl.ownerFabricRoles=response.result||[]}),environmentCtrl.syncModes=[{text:"Do not Sync",value:"OFF"},{text:"Always Sync",value:"FORCE"}],environmentCtrl.addOwner=function(newOwner){newOwner&&(environmentCtrl.environmentData.owners||(environmentCtrl.environmentData.owners=[]),_.findIndex(environmentCtrl.environmentData.owners,{user_id:newOwner})>=0?environmentCtrl.addOwnerError=!0:(environmentCtrl.environmentData.owners.push({displayName:newOwner,uid:newOwner,user_id:newOwner,username:newOwner}),environmentCtrl.allOwners.push({displayName:newOwner,uid:newOwner,user_id:newOwner,username:newOwner}),environmentCtrl.isOpen=!1))},environmentCtrl.addTester=function(newTester,allTesters){newTester&&(environmentCtrl.testers||(environmentCtrl.testers=[]),_.findIndex(environmentCtrl.testers,{user_id:newTester})>=0?environmentCtrl.addNewTesterError=!0:(allTesters.push({displayName:newTester,uid:newTester,user_id:newTester,username:newTester}),environmentCtrl.testers.push({displayName:newTester,uid:newTester,user_id:newTester,username:newTester}),environmentCtrl.isOpen1=!1))},environmentCtrl.initAddNewOwnerPopup=function(){environmentCtrl.isOpen=!environmentCtrl.isOpen},environmentCtrl.initAddNewTesterPopup=function(){environmentCtrl.isOpen1=!environmentCtrl.isOpen1},environmentCtrl.closeAddTesterModal=()=>{environmentCtrl.isOpen1=!1},environmentCtrl.closeAddOwnerModal=()=>{environmentCtrl.isOpen=!1},environmentCtrl.saveUsersAndGroupsTester=(user,userCustom,userGroup,allUsers)=>{if(allUsers&&_.findIndex(environmentCtrl.testers,{user_id:"-1"})<0){const allUsersObj=_.find(environmentCtrl.allTesters,{user_id:"-1"});allUsersObj&&environmentCtrl.testers.push(allUsersObj)}else if(!allUsers&&_.findIndex(environmentCtrl.testers,{user_id:"-1"})>=0){const allUsersIndex=_.findIndex(environmentCtrl.testers,{user_id:"-1"});environmentCtrl.testers.splice(allUsersIndex,1)}if(user){const newUser=angular.copy(user);newUser.user_type="ID",environmentCtrl.testers.push(newUser)}userCustom&&(environmentCtrl.testers.push({user_id:userCustom,user_name:userCustom,username:userCustom,user_type:"ID"}),"newRole"===environmentCtrl.activityPanel?environmentCtrl.allTesters.push({user_id:userCustom,user_name:userCustom,username:userCustom,user_type:"ID"}):environmentCtrl.allTestersRole.push({user_id:userCustom,user_name:userCustom,username:userCustom,user_type:"ID"})),userGroup&&(environmentCtrl.testers.push({user_id:userGroup,user_name:userGroup,username:userGroup,user_type:"GROUP",group:!0}),"newRole"===environmentCtrl.activityPanel?environmentCtrl.allTesters.push({user_id:userGroup,user_name:userGroup,username:userGroup,user_type:"GROUP",group:!0}):environmentCtrl.allTestersRole.push({user_id:userGroup,user_name:userGroup,username:userGroup,user_type:"GROUP",group:!0})),environmentCtrl.allTesters=_.unique(environmentCtrl.allTesters,tester=>`${tester.user_id}_${tester.user_type}`),environmentCtrl.allTestersRole=_.unique(environmentCtrl.allTestersRole,tester=>`${tester.user_id}_${tester.user_type}`),environmentCtrl.isOpen1=!1},environmentCtrl.saveUsersAndGroups=(user,userCustom,userGroup)=>{if(user){const newUser=angular.copy(user);newUser.user_type="ID",environmentCtrl.environmentData.owners.push(newUser)}userCustom&&(environmentCtrl.environmentData.owners.push({user_id:userCustom,user_name:userCustom,username:userCustom,user_type:"ID"}),environmentCtrl.allOwners.push({user_id:userCustom,user_name:userCustom,username:userCustom,user_type:"ID"})),userGroup&&(environmentCtrl.environmentData.owners.push({user_id:userGroup,user_name:userGroup,username:userGroup,user_type:"GROUP",group:!0}),environmentCtrl.allOwners.push({user_id:userGroup,user_name:userGroup,username:userGroup,user_type:"GROUP",group:!0})),environmentCtrl.allOwners=_.unique(environmentCtrl.allOwners,owner=>`${owner.user_id}_${owner.user_type}`),environmentCtrl.isOpen=!1},!environmentCtrl.environmentData.allow_write&&environmentCtrl.environmentData.allow_read?environmentCtrl.envType="Source":environmentCtrl.environmentData.allow_write&&!environmentCtrl.environmentData.allow_read?environmentCtrl.envType="Target":environmentCtrl.environmentData.allow_write&&environmentCtrl.environmentData.allow_read&&(environmentCtrl.envType="Both"),"ON"===environmentCtrl.environmentData.sync_mode&&(environmentCtrl.environmentData.sync_mode=null),environmentCtrl.isFluxMode=AuthService.isFluxMode();var userRole=AuthService.getRole();environmentCtrl.showEnvironment=!0,environmentCtrl.disableOwnersChange="Inactive"==environmentCtrl.environmentData.environment_status||!AuthService.authorizedToEdit(0),environmentCtrl.envTypeChanged=function(){environmentCtrl.envType&&("target"==environmentCtrl.envType.toLowerCase()?(environmentCtrl.environmentData.allow_write=!0,environmentCtrl.environmentData.allow_read=!1):"source"==environmentCtrl.envType.toLowerCase()?(environmentCtrl.environmentData.allow_write=!1,environmentCtrl.environmentData.allow_read=!0):"both"==environmentCtrl.envType.toLowerCase()&&(environmentCtrl.environmentData.allow_write=!0,environmentCtrl.environmentData.allow_read=!0,environmentCtrl.environmentData.mask_sensitive_data=!1))},TDMService.getGenericAPI("wsGetAllEnvs").then((function(response){environmentCtrl.availableSourceEnvironments=_.filter(response.result,(function(env){return env==environmentCtrl.environmentData.environment_name||!(_.findIndex($scope.content.environments,{environment_name:env,environment_status:"Active"})>=0)})),environmentCtrl.environmentData.environment_name&&""!=environmentCtrl.environmentData.environment_name&&environmentCtrl.availableSourceEnvironments.indexOf(environmentCtrl.environmentData.environment_name)<0&&toastr.error("TDM environment "+environmentCtrl.environmentData.environment_name+" is no longer valid","Please update your Environment")})).catch((function(err){toastr.error("Environment","Unable to get available Source Environment")})),environmentCtrl.tabClicked=function(newTab){return environmentCtrl.roleForm?environmentCtrl.roleForm.$dirty&&environmentCtrl.askToSaveChanges("Role",newTab):environmentCtrl.productForm?environmentCtrl.productForm.$dirty&&environmentCtrl.askToSaveChanges("Product",newTab):environmentCtrl.globalForm&&environmentCtrl.globalForm.$dirty&&environmentCtrl.askToSaveChanges("Global",newTab),environmentCtrl.activityPanel="Summary",newTab},environmentCtrl.askToSaveChanges=function(form,newTab){swal({title:"You have unsaved changes.",text:"Do you want to save changes before close?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"No",cancelButtonText:"Yes",closeOnConfirm:!0,closeOnCancel:!0,animation:"false",customClass:"animated fadeInUp"},(function(isConfirm){if(isConfirm)swal("Discard!","Your changes have not been saved!","error");else{switch(form){case"Role":environmentCtrl.saveRoleChanges();break;case"Product":environmentCtrl.saveProductChanges();break;case"Global":environmentCtrl.saveGlobalChanges()}swal("Saved!","Your changes have been saved.","success")}environmentCtrl.activityPanel="Summary",environmentCtrl.newTab=newTab}))},environmentCtrl.barOptions={scaleBeginAtZero:!0,scaleShowGridLines:!0,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,barShowStroke:!1,barStrokeWidth:0},environmentCtrl.getSummaryData=function($scope){environmentCtrl.loadingSummary=!0,TDMService.getEnvironmentSummary(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.summaryData=response.result,environmentCtrl.summaryData.numberOfALLTesters.value=parseInt(environmentCtrl.summaryData.numberOfALLTesters.value),environmentCtrl.summaryData.tasks.active=parseInt(environmentCtrl.summaryData.tasks.active),environmentCtrl.summaryData.tasks.onHold=parseInt(environmentCtrl.summaryData.tasks.onhold),null!=environmentCtrl.summaryData.processedEntities.processedentities?environmentCtrl.summaryData.processedEntities.processedentities=parseInt(environmentCtrl.summaryData.processedEntities.processedentities):environmentCtrl.summaryData.processedEntities.processedentities=0,environmentCtrl.taskExecutionsBarData={labels:["Failed","Pending","Paused","Stopped","Running","Completed"],datasets:[{label:"Exection status",fillColor:"rgba(26,179,148,0.5)",strokeColor:"rgba(26,179,148,0.8)",highlightFill:"rgba(26,179,148,0.75)",highlightStroke:"rgba(26,179,148,1)",data:[environmentCtrl.summaryData.taskExecutionStatus.failed,environmentCtrl.summaryData.taskExecutionStatus.pending,environmentCtrl.summaryData.taskExecutionStatus.paused,environmentCtrl.summaryData.taskExecutionStatus.stopped,environmentCtrl.summaryData.taskExecutionStatus.running,environmentCtrl.summaryData.taskExecutionStatus.completed]}]},environmentCtrl.loadingSummary=!1,environmentCtrl.activityPanel="Summary"):(environmentCtrl.loadingSummary=!1,environmentCtrl.activityPanel="Summary")}))},environmentCtrl.getSummaryData(),TDMService.getEnvTaskCount(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode?environmentCtrl.tasksCount=response.result:environmentCtrl.tasksCount=!0})),TDMService.getDataCenters().then((function(response){"SUCCESS"==response.errorCode?environmentCtrl.dataCenters=_.unique(response.result,"dc"):toastr.error("Environment # "+environmentCtrl.environmentData.environment_id,"failed to get data centers")})),TDMService.getEnvironmentOwners(environmentCtrl.environmentData.environment_id).then((function(response){if("SUCCESS"==response.errorCode){if(environmentCtrl.environmentData.owners=response.result,TDMService.getFabricRoles("tester").then(response=>{environmentCtrl.testerFabricRoles=(response.result||[]).concat(environmentCtrl.ownerFabricRoles.filter(owner=>_.findIndex(environmentCtrl.environmentData.owners,{user_id:owner,user_type:"GROUP"})<0))}),"admin"==userRole.type)environmentCtrl.environmentData.isOwner=!0;else{var ownerFound=_.find(response.result,{user_id:AuthService.getUserId()});if(!ownerFound)for(let i=0;i<environmentCtrl.ownerFabricRoles.length;i++){const fabricRole=environmentCtrl.ownerFabricRoles[i];if(ownerFound=_.find(response.result,{user_id:fabricRole,user_type:"GROUP"}))break}environmentCtrl.environmentData.isOwner=!!ownerFound}environmentCtrl.disableChange="Inactive"===environmentCtrl.environmentData.environment_status||!environmentCtrl.environmentData.isOwner}else toastr.error("Environment # "+environmentCtrl.environmentData.environment_name,"failed to get owners : "+response.message),environmentCtrl.environmentData.owners=[];TDMService.getUsersByPermssionGroups("owner").then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.allOwners=_.map(response.result,item=>(item.user_type||(item.user_type="ID"),item)),environmentCtrl.environmentData.owners.forEach(owner=>{_.findIndex(environmentCtrl.allOwners,{user_id:owner.user_id})<0&&environmentCtrl.allOwners.push({user_type:owner.user_type,displayName:owner.user_id,uid:owner.user_id,user_id:owner.user_id,username:owner.user_id})})):(toastr.error("Environment # "+environmentCtrl.environmentData.environment_name,"failed to get owners: "+response.message),environmentCtrl.allOwners=[])}))})),environmentCtrl.saveChanges=function(){TDMService.updateEnvironment(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("Environment # "+environmentCtrl.environmentData.environment_name,"Updated Successfully"),$scope.content.openEnvironments()):toastr.error("Environment # "+environmentCtrl.environmentData.environment_name,"failed to Update : "+response.message)}))},environmentCtrl.deleteEnvironment=function(){1==environmentCtrl.tasksCount?SweetAlert.swal({title:"Environment will be deleted from all releated tasks. Are you sure?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"No",cancelButtonText:"Yes",closeOnConfirm:!0,closeOnCancel:!0,animation:"false",customClass:"animated fadeInUp"},(function(isConfirm){isConfirm||TDMService.deleteEnvironment(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("Environment # "+environmentCtrl.environmentData.environment_name,"deleted Successfully"),$timeout((function(){$scope.content.openEnvironments()}),400)):toastr.error("Environment # "+environmentCtrl.environmentData.environment_name,"failed to delete")}))})):TDMService.deleteEnvironment(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("Environment # "+environmentCtrl.environmentData.environment_name,"deleted Successfully"),$timeout((function(){$scope.content.openEnvironments()}),400)):toastr.error("Environment # "+environmentCtrl.environmentData.environment_name,"failed to delete")}))},BreadCrumbsService.breadCrumbChange(1),BreadCrumbsService.push({environmentID:environmentCtrl.environmentData.environment_name},"ENVIRONMENT_BREADCRUMB",(function(){$scope.content.openEnvironment(environmentCtrl.environmentData)})),environmentCtrl.openRolesManagement=function(){$scope.content.openRoles(environmentCtrl.environmentData)},environmentCtrl.openProducts=function(){$scope.content.openProducts(environmentCtrl.environmentData)},environmentCtrl.loadingTableRoles=!0,TDMService.getEnvironmentRoles(environmentCtrl.environmentData.environment_id).then((function(response){if("SUCCESS"==response.errorCode){environmentCtrl.roles=_.sortBy(response.result,(function(value){return new Date(value.role_creation_date)})),environmentCtrl.roles.reverse(),environmentCtrl.dtInstanceRoles={},environmentCtrl.dtColumnsRoles=[],environmentCtrl.dtColumnDefsRoles=[],environmentCtrl.headersRoles=[{column:"role_name",name:"Name",clickAble:!0},{column:"role_description",name:"Description",clickAble:!1},{column:"role_creation_date",name:"Creation Date",clickAble:!1,type:"date"},{column:"role_created_by",name:"Created By",clickAble:!1},{column:"role_last_updated_date",name:"Last Update Date",clickAble:!1,type:"date"},{column:"role_last_updated_by",name:"Updated By",clickAble:!1},{column:"role_status",name:"Status",clickAble:!1}];for(var clickAbleColumn=function(data,type,full,meta){return'<a id="environment_open_role_'+meta.row+'" ng-click="environmentCtrl.openRole('+meta.row+')">'+data+"</a>"},changeToLocalDate=function(data,type,full,meta){return moment(data).format("D MMM YYYY, HH:mm")},i=0;i<environmentCtrl.headersRoles.length;i++)1==environmentCtrl.headersRoles[i].clickAble?environmentCtrl.dtColumnsRoles.push(DTColumnBuilder.newColumn(environmentCtrl.headersRoles[i].column).withTitle(environmentCtrl.headersRoles[i].name).renderWith(clickAbleColumn)):"date"==environmentCtrl.headersRoles[i].type?environmentCtrl.dtColumnsRoles.push(DTColumnBuilder.newColumn(environmentCtrl.headersRoles[i].column).withTitle(environmentCtrl.headersRoles[i].name).renderWith(changeToLocalDate)):environmentCtrl.dtColumnsRoles.push(DTColumnBuilder.newColumn(environmentCtrl.headersRoles[i].column).withTitle(environmentCtrl.headersRoles[i].name));var getTableData=function(){var deferred=$q.defer();return deferred.resolve(environmentCtrl.roles),deferred.promise};environmentCtrl.dtOptionsRoles=DTOptionsBuilder.fromFnPromise((function(){return getTableData()})).withDOM("lTfgitp").withOption("createdRow",(function(row){$compile(angular.element(row).contents())($scope)})).withOption("scrollX",!1).withOption("aaSorting",[6,"asc"]).withOption("lengthChange",!1).withOption("paging",!1).withOption("searching",!0).withOption("info",!1).withOption("caseInsensitive",!0).withOption("search",{caseInsensitive:!1}),environmentCtrl.dtOptionsRoles.withLightColumnFilter({0:{type:"text"},1:{type:"text"},2:{type:"text"},3:{type:"select",values:_.map(_.unique(_.map(environmentCtrl.roles,"role_created_by")),(function(el){return{value:el,label:el}}))},4:{type:"text"},5:{type:"select",values:_.map(_.unique(_.map(environmentCtrl.roles,"role_last_updated_by")),(function(el){return{value:el,label:el}}))},6:{type:"select",defaultValue:"Active",values:[{value:"Inactive",label:"Inactive"},{value:"Active",label:"Active"}]}}),environmentCtrl.dtInstanceCallbackRoles=function(dtInstance){angular.isFunction(environmentCtrl.dtInstanceRoles)?environmentCtrl.dtInstanceRoles(dtInstance):angular.isDefined(environmentCtrl.dtInstanceRoles)&&(environmentCtrl.dtInstanceRoles=dtInstance)},null!=environmentCtrl.dtInstanceRoles.changeData&&environmentCtrl.dtInstanceRoles.changeData(getTableData()),environmentCtrl.loadingTableRoles=!1}})),TDMService.getEnvGlobals(environmentCtrl.environmentData.environment_id).then((function(response){if("SUCCESS"==response.errorCode){environmentCtrl.globals=_.sortBy(response.result,(function(value){return new Date(value.update_date)})),environmentCtrl.globals.reverse(),environmentCtrl.dtInstanceGlobals={},environmentCtrl.dtColumnsGlobals=[],environmentCtrl.dtColumnDefsGlobals=[],environmentCtrl.headersGlobals=[{column:"global_name",name:"Name",clickAble:!1,clickAble:!0},{column:"global_value",name:"Value",clickAble:!1},{column:"update_date",name:"Last Update date",type:"date",clickAble:!1},{column:"updated_by",name:"Updated By",clickAble:!1}];for(var clickAbleColumn=function(data,type,full,meta){return'<a id="environment_open_global_'+meta.row+'" ng-click="environmentCtrl.openGlobal('+meta.row+')">'+data+"</a>"},changeToLocalDate=function(data,type,full,meta){return data?moment(data).format("D MMM YYYY, HH:mm"):""},i=0;i<environmentCtrl.headersGlobals.length;i++)1==environmentCtrl.headersGlobals[i].clickAble?environmentCtrl.dtColumnsGlobals.push(DTColumnBuilder.newColumn(environmentCtrl.headersGlobals[i].column).withTitle(environmentCtrl.headersGlobals[i].name).renderWith(clickAbleColumn)):"date"==environmentCtrl.headersGlobals[i].type?environmentCtrl.dtColumnsGlobals.push(DTColumnBuilder.newColumn(environmentCtrl.headersGlobals[i].column).withTitle(environmentCtrl.headersGlobals[i].name).renderWith(changeToLocalDate)):environmentCtrl.dtColumnsGlobals.push(DTColumnBuilder.newColumn(environmentCtrl.headersGlobals[i].column).withTitle(environmentCtrl.headersGlobals[i].name));var getTableDataGlobals=function(){var deferred=$q.defer();return deferred.resolve(environmentCtrl.globals),deferred.promise};environmentCtrl.dtOptionsGlobals=DTOptionsBuilder.fromFnPromise((function(){return getTableDataGlobals()})).withDOM("lTfgitp").withOption("createdRow",(function(row){$compile(angular.element(row).contents())($scope)})).withOption("scrollX",!1).withOption("aaSorting",[environmentCtrl.headersGlobals.length-2,"desc"]).withOption("lengthChange",!1).withOption("paging",!1).withOption("searching",!1).withOption("info",!1),environmentCtrl.dtInstanceCallbackGlobals=function(dtInstance){angular.isFunction(environmentCtrl.dtInstanceGlobals)?environmentCtrl.dtInstanceGlobals(dtInstance):angular.isDefined(environmentCtrl.dtInstanceGlobals)&&(environmentCtrl.dtInstanceGlobals=dtInstance)},null!=environmentCtrl.dtInstanceGlobals.changeData&&environmentCtrl.dtInstanceGlobals.changeData(getTableDataGlobals()),environmentCtrl.loadingTableGlobals=!1}else toastr.error("Environment # "+environmentCtrl.environmentData.environment_id,"Faild to get Globals")})),TDMService.getEnvProducts(environmentCtrl.environmentData.environment_id).then((function(response){if("SUCCESS"==response.errorCode){environmentCtrl.products=_.sortBy(response.result,(function(value){return new Date(value.creation_date)})),environmentCtrl.products.reverse(),environmentCtrl.dtInstanceProducts={},environmentCtrl.dtColumnsProducts=[],environmentCtrl.dtColumnDefsProducts=[],environmentCtrl.headersProducts=[{column:"product_name",name:"Name",clickAble:!0},{column:"data_center_name",name:"Data Center",clickAble:!1},{column:"product_version",name:"Version",clickAble:!1},{column:"created_by",name:"Created By",clickAble:!1},{column:"creation_date",name:"Creation Date",clickAble:!1,type:"date"},{column:"last_updated_by",name:"Updated By",clickAble:!1},{column:"last_updated_date",name:"Update Date",clickAble:!1,type:"date"},{column:"status",name:"Status",clickAble:!1}];for(var clickAbleColumn=function(data,type,full,meta){return'<a id="environment_open_product_'+meta.row+'" ng-click="environmentCtrl.openProduct('+meta.row+')">'+data+"</a>"},changeToLocalDate=function(data,type,full,meta){return data?moment(data).format("D MMM YYYY, HH:mm"):""},i=0;i<environmentCtrl.headersProducts.length;i++)1==environmentCtrl.headersProducts[i].clickAble?environmentCtrl.dtColumnsProducts.push(DTColumnBuilder.newColumn(environmentCtrl.headersProducts[i].column).withTitle(environmentCtrl.headersProducts[i].name).renderWith(clickAbleColumn)):"date"==environmentCtrl.headersProducts[i].type?environmentCtrl.dtColumnsProducts.push(DTColumnBuilder.newColumn(environmentCtrl.headersProducts[i].column).withTitle(environmentCtrl.headersProducts[i].name).renderWith(changeToLocalDate)):environmentCtrl.dtColumnsProducts.push(DTColumnBuilder.newColumn(environmentCtrl.headersProducts[i].column).withTitle(environmentCtrl.headersProducts[i].name));var getTableDataProducts=function(){var deferred=$q.defer();return deferred.resolve(environmentCtrl.products),deferred.promise};environmentCtrl.dtOptionsProducts=DTOptionsBuilder.fromFnPromise((function(){return getTableDataProducts()})).withDOM("lTfgitp").withOption("createdRow",(function(row){$compile(angular.element(row).contents())($scope)})).withOption("aaSorting",[7,"asc"]).withOption("scrollX",!1).withOption("searching",!0).withOption("caseInsensitive",!0).withOption("search",{caseInsensitive:!1}),environmentCtrl.dtOptionsProducts.withLightColumnFilter({0:{type:"text"},1:{type:"select",values:_.map(_.unique(_.map(environmentCtrl.products,"data_center_name")),(function(el){return{value:el,label:el}}))},2:{type:"text"},3:{type:"select",values:_.map(_.unique(_.map(environmentCtrl.products,"created_by")),(function(el){return{value:el,label:el}}))},4:{type:"text"},5:{type:"select",values:_.map(_.unique(_.map(environmentCtrl.products,"last_updated_by")),(function(el){return{value:el,label:el}}))},6:{type:"text"},7:{type:"select",defaultValue:"Active",values:[{value:"Inactive",label:"Inactive"},{value:"Active",label:"Active"}]}}),environmentCtrl.dtInstanceCallbackProducts=function(dtInstance){angular.isFunction(environmentCtrl.dtInstanceProducts)?environmentCtrl.dtInstanceProducts(dtInstance):angular.isDefined(environmentCtrl.dtInstanceProducts)&&(environmentCtrl.dtInstanceProducts=dtInstance)},null!=environmentCtrl.dtInstanceProducts.changeData&&environmentCtrl.dtInstanceProducts.changeData(getTableDataProducts()),environmentCtrl.loadingTableProducts=!1}else toastr.error("Environment # "+environmentCtrl.environmentData.environment_id,"Failed to get products")})),environmentCtrl.refreshBusnisEntities=function(){TDMService.getBusinessEntitiesForEnvProducts(environmentCtrl.environmentData.environment_id).then((function(response){var allBusinessEntities=response.result;"SUCCESS"==response.errorCode?(environmentCtrl.allBusinessEntities=allBusinessEntities,TDMService.getUsersByPermssionGroups("admin").then((function(response){var admins=response.result;"SUCCESS"==response.errorCode?(environmentCtrl.allusers=admins,TDMService.getEnvTesters(environmentCtrl.environmentData.environment_id).then((function(response){var testers=response.result;"SUCCESS"==response.errorCode?(environmentCtrl.allusers=testers.concat(environmentCtrl.allusers),TDMService.getEnvironmentOwners(environmentCtrl.environmentData.environment_id).then((function(response){var owners=response.result;if(TDMService.getFabricRoles("tester").then(response=>{environmentCtrl.testerFabricRoles=(response.result||[]).concat(environmentCtrl.ownerFabricRoles.filter(owner=>_.findIndex(owners,{user_id:owner,user_type:"GROUP"})<0))}),"SUCCESS"==response.errorCode){var ownersNewStructArray=[];owners.forEach((function(owner){var anOwner={};anOwner.uid=owner.user_id,ownersNewStructArray.push(anOwner)})),environmentCtrl.allusers=ownersNewStructArray.concat(environmentCtrl.allusers)}else toastr.error("Failed to get Environment Owners")}))):toastr.error("Failed to get Environment Testers")}))):toastr.error("Failed to get all Admins")}))):toastr.error("Failed to get Business Entities")}))},environmentCtrl.refreshBusnisEntities(),TDMService.getTesters(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.allTesters=_.map(response.result,tester=>(tester.user_type||(tester.user_type="ID"),tester)),environmentCtrl.allTesters=_.uniq(environmentCtrl.allTesters,"user_id"),_.remove(environmentCtrl.allTesters,(function(tester){return!!_.find(environmentCtrl.environmentData.owners,{user_id:tester.user_id})}))):(environmentCtrl.hideUsersInput=!0,toastr.error("Environment # "+environmentCtrl.environmentData.environment_name,"failed to get All Testers : "+response.message))})),environmentCtrl.openRole=function(index){environmentCtrl.roleData=angular.copy(environmentCtrl.roles[index]),environmentCtrl.disableChangeRole=environmentCtrl.disableChange||"Inactive"==environmentCtrl.roleData.role_status||!AuthService.authorizedToEdit(1)||!environmentCtrl.environmentData.isOwner,environmentCtrl.isOpen1=!1,TDMService.getEnvironmentRoleTesters(environmentCtrl.environmentData.environment_id,environmentCtrl.roleData.role_id).then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.testers=_.map(response.result,tester=>(tester.user_type||(tester.user_type="ID"),tester)),environmentCtrl.testersIds=environmentCtrl.testers.map(it=>it.user_id),environmentCtrl.allTesters||(environmentCtrl.allTesters=[]),environmentCtrl.allTestersRole=environmentCtrl.allTesters.concat(environmentCtrl.testers)):(environmentCtrl.hideUsersInput=!0,toastr.error("Role # "+environmentCtrl.roleData.role_name,"failed to get Role Users : "+response.message))})),environmentCtrl.activityPanel="empty",$timeout((function(){environmentCtrl.activityPanel="Role"}),200)},environmentCtrl.deleteRole=function(){TDMService.deleteEnvironmentRole(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,environmentCtrl.roleData.role_id,environmentCtrl.roleData.role_name).then((function(response){if("SUCCESS"==response.errorCode){toastr.success("Role # "+environmentCtrl.roleData.role_name,"deleted Successfully"),toastr.warning("The entities of the removed users need to be released from the environment."),environmentCtrl.roleData.role_status="Inactive";var currentRole=_.find(environmentCtrl.roles,{role_id:environmentCtrl.roleData.role_id});currentRole&&(currentRole.role_status="Inactive"),environmentCtrl.dtInstanceRoles.reloadData((function(data){}),!0),TDMService.getTesters(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.allTesters=_.map(response.result,tester=>(tester.user_type||(tester.user_type="ID"),tester)),_.remove(environmentCtrl.allTesters,(function(tester){return!!_.find(environmentCtrl.environmentData.owners,{user_id:tester.user_id})}))):(environmentCtrl.hideUsersInput=!0,toastr.error("Environment # "+environmentCtrl.environmentData.environment_name,"failed to get All Testers : "+response.message))})),environmentCtrl.getSummaryData()}else toastr.error("Role # "+environmentCtrl.roleData.role_name,"failed to delete")}))},environmentCtrl.saveRoleChanges=function(){const testerIds=environmentCtrl.testers.map(it=>it.user_id);let showWarningMessage=!1;for(let i=0;i<environmentCtrl.testersIds.length;i++)if(testerIds.indexOf(environmentCtrl.testersIds[i])<0){showWarningMessage=!0;break}environmentCtrl.testersIds=[],TDMService.postEnvironmentRoleTesters(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,environmentCtrl.roleData.role_id,environmentCtrl.roleData.role_name,environmentCtrl.testers).then((function(response){"SUCCESS"==response.errorCode?(showWarningMessage&&toastr.warning("The entities of the removed users need to be released from the environment."),toastr.success("Role Users # "+environmentCtrl.roleData.role_name,"Updated Successfully"),TDMService.getTesters(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.allTesters=_.map(response.result,tester=>(tester.user_type||(tester.user_type="ID"),tester)),_.remove(environmentCtrl.allTesters,(function(tester){return!!_.find(environmentCtrl.environmentData.owners,{user_id:tester.user_id})}))):(environmentCtrl.hideUsersInput=!0,toastr.error("Environment # "+environmentCtrl.environmentData.environment_name,"failed to get All Testers : "+response.message))})),environmentCtrl.getSummaryData()):toastr.error("Role Users # "+environmentCtrl.roleData.role_name,"failed to Update : "+response.message)})),TDMService.updateEnvironmentRole(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,environmentCtrl.roleData.role_id,environmentCtrl.roleData).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("Role # "+environmentCtrl.roleData.role_name,"Updated Successfully"),TDMService.getEnvironmentRoles(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode&&(environmentCtrl.roles=response.result,environmentCtrl.dtInstanceRoles.reloadData((function(data){}),!0))}))):toastr.error("Role # "+environmentCtrl.roleData.role_name,"failed to Update : "+response.message)}))},environmentCtrl.openNewRole=function(){environmentCtrl.roleData={allowed_test_conn_failure:!1,allowed_creation_of_synthetic_data:!1,allowed_delete_before_load:!1,allowed_random_entity_selection:!1,allowed_request_of_fresh_data:!1,allowed_task_scheduling:!1,allowed_replace_sequences:!1,allowed_refresh_reference_data:!1,allowed_entity_versioning:!1,allowed_number_of_reserved_entities:0,allowed_number_of_entities_to_copy:0,allowed_number_of_entities_to_read:0,role_description:"",role_name:"",allow_read:!!environmentCtrl.environmentDataOrig.allow_read,allow_write:!!environmentCtrl.environmentDataOrig.allow_write},environmentCtrl.isOpen1=!1,environmentCtrl.activityPanel="newRole",environmentCtrl.testers=[],environmentCtrl.allTesters||(environmentCtrl.allTesters=[])},environmentCtrl.addNewRole=function(){if(_.find(environmentCtrl.roles,{role_name:environmentCtrl.roleData.role_name,role_status:"Active"}))return toastr.error("Role # "+environmentCtrl.roleData.role_name+" Already Exists");TDMService.postEnvironmentRole(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,environmentCtrl.roleData).then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.getSummaryData(),TDMService.getEnvironmentRoles(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode&&(environmentCtrl.roles=response.result,environmentCtrl.dtInstanceRoles.reloadData((function(data){}),!0))})),toastr.success("Role # "+environmentCtrl.roleData.role_name,"Created Successfully"),environmentCtrl.getSummaryData(),TDMService.postEnvironmentRoleTesters(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,response.result.id,environmentCtrl.roleData.role_name,environmentCtrl.testers).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("Role Users # "+environmentCtrl.roleData.role_name,"Updated Successfully"),TDMService.getTesters(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.allTesters=_.map(response.result,tester=>(tester.user_type||(tester.user_type="ID"),tester)),_.remove(environmentCtrl.allTesters,(function(tester){return!!_.find(environmentCtrl.environmentData.owners,{user_id:tester.user_id})}))):(environmentCtrl.hideUsersInput=!0,toastr.error("Environment # "+environmentCtrl.environmentData.environment_name,"failed to get All Testers : "+response.message))}))):toastr.error("Role Users # "+environmentCtrl.roleData.role_name,"failed to Update : "+response.message)}))):toastr.error("Role # "+environmentCtrl.roleData.role_name,"Unable to Create : "+response.message)}))},environmentCtrl.addNewGlobal=function(){if(environmentCtrl.globalData.update_date=(new Date).toUTCString(),environmentCtrl.globalData.updated_by=environmentCtrl.environmentData.environment_last_updated_by,console.log(environmentCtrl.globalData),_.find(environmentCtrl.globals,{global_name:environmentCtrl.globalData.global_name}))return toastr.error("Global # "+environmentCtrl.globalData.global_name+" Already Exists");TDMService.postEnvGlobal(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,environmentCtrl.globalData).then((function(response){"SUCCESS"==response.errorCode?(TDMService.getEnvGlobals(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode&&(environmentCtrl.globals=response.result,environmentCtrl.dtInstanceGlobals.reloadData((function(data){}),!0))})),toastr.success("Global # "+environmentCtrl.globalData.global_name,"Created Successfully"),environmentCtrl.getSummaryData()):toastr.error("Global # "+environmentCtrl.roleData.role_name,"Unable to Create : "+response.message)}))};environmentCtrl.exclusionPattern=new RegExp("^((\\w|-)+(?:,(\\w|-)+){0,})?$"),environmentCtrl.beIsSelected=!1,environmentCtrl.onBeSelect=function(){environmentCtrl.beIsSelected=!0},environmentCtrl.validateExclusionListRequestedBy=function(){console.log("validating Exclusion List requested by: nev_id="+environmentCtrl.environmentData.environment_id+"\n"),console.log(environmentCtrl.exclusionListData),environmentCtrl.exclusionListRequestedByIsNotValid=!1,TDMService.postEnvExclusionListValidateRequestedBy(environmentCtrl.environmentData.environment_id,environmentCtrl.exclusionListData).then((function(response){"SUCCESS"==response.errorCode?response.result.length>0&&(environmentCtrl.exclusionListRequestedByIsNotValid=!0):toastr.error("Unable to execute Exclusion List Validation 1: "+response.message)}))},environmentCtrl.validateAndAddExclusionList=function(){console.log("validating Exclusion List "),environmentCtrl.patternFailed=!1,environmentCtrl.exclusionListIsNotValid=!1,environmentCtrl.exclusionListData.exclusion_list=environmentCtrl.exclusionListData.exclusion_list.replace(/\s/g,""),environmentCtrl.exclusionListData.exclusion_list=environmentCtrl.exclusionListData.exclusion_list.replace(/\r?\n|\r/g,""),environmentCtrl.exclusionPattern.test(environmentCtrl.exclusionListData.exclusion_list)?TDMService.postEnvExclusionListValidateList(environmentCtrl.environmentData.environment_id,environmentCtrl.exclusionListData).then((function(response){if("SUCCESS"==response.errorCode)if(response.result.length>0){environmentCtrl.exclusionListIsNotValid=!0,environmentCtrl.existingExclusionListMembers=[];for(var i=0;i<response.result.length;i++)environmentCtrl.existingExclusionListMembers.push(response.result[i].unnest)}else console.log("add new exclusion list"),TDMService.postEnvExclusionList(environmentCtrl.environmentData.environment_id,environmentCtrl.exclusionListData).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("An Exclusion List was added successfully"),TDMService.getEnvExclusionLists(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.exclusionLists=_.sortBy(response.result,(function(value){return new Date(value.creation_date)})),environmentCtrl.dtInstanceExclusionLists.reloadData((function(data){}),!0),environmentCtrl.getSummaryData()):toastr.error("Environment # "+environmentCtrl.environmentData.environment_id,"Failed to get Exclusion Lists")}))):toastr.error("Failed to add an Exclusion List"+response.message)}));else toastr.error("Unable to execute Exclusion List Validation 2: "+response.message)})):environmentCtrl.patternFailed=!0},environmentCtrl.validateAndSaveExclusionList=function(){console.log("validating Exclusion List "),environmentCtrl.patternFailed=!1,environmentCtrl.exclusionListIsNotValid=!1,environmentCtrl.exclusionListData.exclusion_list=environmentCtrl.exclusionListData.exclusion_list.replace(/\s/g,""),environmentCtrl.exclusionListData.exclusion_list=environmentCtrl.exclusionListData.exclusion_list.replace(/\r?\n|\r/g,""),environmentCtrl.exclusionPattern.test(environmentCtrl.exclusionListData.exclusion_list)?TDMService.postEnvExclusionListValidateListBeforeUpdate(environmentCtrl.environmentData.environment_id,environmentCtrl.exclusionListData).then((function(response){if("SUCCESS"==response.errorCode)if(response.result.length>0){environmentCtrl.exclusionListIsNotValid=!0,environmentCtrl.existingExclusionListMembers=[];for(var i=0;i<response.result.length;i++)environmentCtrl.existingExclusionListMembers.push(response.result[i].unnest)}else console.log("save exclusion list. id: "+environmentCtrl.exclusionListData.be_env_exclusion_list_id),TDMService.putEnvExclusionList(environmentCtrl.environmentData.environment_id,environmentCtrl.exclusionListData.be_env_exclusion_list_id,environmentCtrl.exclusionListData).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("An Exclusion List was added successfully"),TDMService.getEnvExclusionLists(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.exclusionLists=_.sortBy(response.result,(function(value){return new Date(value.creation_date)})),environmentCtrl.dtInstanceExclusionLists.reloadData((function(data){}),!0),environmentCtrl.getSummaryData()):toastr.error("Environment # "+environmentCtrl.environmentData.environment_id,"Failed to get Exclusion Lists")}))):toastr.error("Failed to add an Exclusion List"+response.message)}));else toastr.error("Unable to execute Exclusion List Validation 2: "+response.message)})):environmentCtrl.patternFailed=!0},environmentCtrl.openExclusionList=function(index){environmentCtrl.exclusionListRequestedByIsNotValid=!1,environmentCtrl.disableChangeExclusionList=!1,environmentCtrl.exclusionListIsNotValid=!1,environmentCtrl.exclusionListData=angular.copy(environmentCtrl.exclusionLists[index]),environmentCtrl.disableChangeExclusionList=environmentCtrl.disableChange||!AuthService.authorizedToEdit(1)||!environmentCtrl.environmentData.isOwner,environmentCtrl.activityPanel="empty",$timeout((function(){environmentCtrl.activityPanel="ExclusionList"}),200)},environmentCtrl.deleteExclusionList=function(){TDMService.deleteEnvExclusionList(environmentCtrl.environmentData.environment_id,environmentCtrl.exclusionListData.be_env_exclusion_list_id).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("Exclusion List deleted Successfully"),TDMService.getEnvExclusionLists(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode?(environmentCtrl.exclusionLists=_.sortBy(response.result,(function(value){return new Date(value.creation_date)})),environmentCtrl.dtInstanceExclusionLists.reloadData((function(data){}),!0),environmentCtrl.getSummaryData()):toastr.error("Environment # "+environmentCtrl.environmentData.environment_id,"Failed to get Exclusion Lists")}))):toastr.error("Exclusion List failed to delete")}))},environmentCtrl.openNewExclusionList=function(){environmentCtrl.disableChangeExclusionList=!1,environmentCtrl.exclusionListIsNotValid=!1,environmentCtrl.exclusionListData={},environmentCtrl.activityPanel="newExclusionList"},TDMService.getDataCenters().then((function(response){"SUCCESS"==response.errorCode?environmentCtrl.dataCenters=_.unique(_.filter(response.result,(function(dc){return"ALIVE"==dc.status})),"dc"):toastr.error("Environment # "+environmentCtrl.environmentData.environment_name,"Failed to get data centers")})),environmentCtrl.openProduct=function(index){environmentCtrl.productData=angular.copy(environmentCtrl.products[index]),environmentCtrl.productData.product_id&&TDMService.getProductLogicalUnits(environmentCtrl.productData.product_id).then((function(response){environmentCtrl.logicalUnitsForProduct=response.result,environmentCtrl.dataCenterChanged()})),environmentCtrl.disableChangeProduct=environmentCtrl.disableChange||"Inactive"==environmentCtrl.productData.status||!AuthService.authorizedToEdit(1)||!environmentCtrl.environmentData.isOwner,environmentCtrl.activityPanel="empty",$timeout((function(){environmentCtrl.activityPanel="Product"}),200)},environmentCtrl.openGlobal=function(index){environmentCtrl.environmentData.isOwner&&(TDMService.getAllGlobals(null).then((function(response){var envGlobals=response.result;"SUCCESS"==response.errorCode?(environmentCtrl.newEnvGlobals=envGlobals,environmentCtrl.disableChangeGlobal=!1,environmentCtrl.globalData=angular.copy(environmentCtrl.globals[index]),environmentCtrl.globalData.luName=environmentCtrl.globalData.lu_name,environmentCtrl.globalChanged(!0)):toastr.error("Environment # "+environmentCtrl.environmentData.environment_id,"Faild to get new products")})),environmentCtrl.activityPanel="empty",$timeout((function(){environmentCtrl.activityPanel="Global"}),200))},environmentCtrl.deleteProduct=function(){TDMService.deleteEnvProduct(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,environmentCtrl.productData.product_id).then((function(response){if("SUCCESS"==response.errorCode){toastr.success("System # "+environmentCtrl.productData.product_name,"deleted Successfully"),environmentCtrl.productData.status="Inactive";var currentProduct=_.find(environmentCtrl.products,{product_id:environmentCtrl.productData.product_id});currentProduct&&(currentProduct.status="Inactive"),environmentCtrl.dtInstanceProducts.reloadData((function(data){}),!0),environmentCtrl.getSummaryData()}else toastr.error("System # "+environmentCtrl.productData.product_name,"failed to delete")}))},environmentCtrl.deleteGlobal=function(){TDMService.deleteEnvGlobal(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,environmentCtrl.globalData.global_name,environmentCtrl.globalData.lu_name).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("Global # "+environmentCtrl.globalData.global_name,"deleted Successfully"),TDMService.getEnvGlobals(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode&&(environmentCtrl.globals=_.sortBy(response.result,(function(value){return new Date(value.update_date)})),environmentCtrl.globals.reverse(),environmentCtrl.dtInstanceGlobals.reloadData((function(data){}),!0))})),environmentCtrl.getSummaryData()):toastr.error("Global # "+environmentCtrl.globalData.global_name,"failed to delete")}))},environmentCtrl.saveProductChanges=function(){TDMService.putEnvProduct(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,environmentCtrl.productData).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("System # "+environmentCtrl.productData.product_name,"Updated Successfully"),TDMService.getEnvProducts(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode&&(environmentCtrl.products=response.result,environmentCtrl.dtInstanceProducts.reloadData((function(data){}),!0))})),environmentCtrl.getSummaryData()):toastr.error("System # "+environmentCtrl.productData.product_name,"failed to update")}))},environmentCtrl.saveGlobalChanges=function(){TDMService.putEnvGlobal(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,environmentCtrl.globalData).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("Global # "+environmentCtrl.globalData.global_name,"Updated Successfully"),"SUCCESS"==response.errorCode&&TDMService.getEnvGlobals(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode&&(environmentCtrl.globals=_.sortBy(response.result,(function(value){return new Date(value.update_date)})),environmentCtrl.globals.reverse(),environmentCtrl.dtInstanceGlobals.reloadData((function(data){}),!0))})),environmentCtrl.getSummaryData()):toastr.error("Global # "+environmentCtrl.globalData.global_name,"failed to update")}))},environmentCtrl.openEnvProductInterfaceEdit=function(index){var environmentDataOrig=environmentCtrl.environmentDataOrig;$uibModal.open({templateUrl:"views/environments/environmentProductInterfaceModal.html",resolve:{dbInterface:environmentCtrl.productData.interfaces[index],disableChange:environmentCtrl.disableChangeProduct||"Inactive"==environmentCtrl.productData.interfaces[index].env_product_interface_status},controller:function($scope,$uibModalInstance,dbInterface,disableChange){var dbInterfaceCtrl=this;dbInterfaceCtrl.dbInterfaceData=dbInterface,environmentDataOrig.allow_read&&environmentDataOrig.allow_write&&!dbInterfaceCtrl.dbInterfaceData.db_host&&!dbInterfaceCtrl.dbInterfaceData.db_connection_string&&TDMService.postGenericAPI("interfaceConnectionDetails",{interfaceName:dbInterfaceCtrl.dbInterfaceData.interface_name,environmentName:environmentDataOrig.environment_name}).then((function(response){console.log(response.result),response.result&&response.result.length>0&&(dbInterfaceCtrl.dbInterfaceData.db_host=response.result[0],dbInterfaceCtrl.dbInterfaceData.db_port=parseInt(response.result[1]),dbInterfaceCtrl.dbInterfaceData.db_user=response.result[3],dbInterfaceCtrl.dbInterfaceData.db_password=response.result[4],dbInterfaceCtrl.dbInterfaceData.db_schema=response.result[2],TDMService.decryptInterfacePassword({db_password:dbInterfaceCtrl.dbInterfaceData.db_password}).then((function(response){"FAILED"!=response.errorCode&&response.result?dbInterfaceCtrl.dbInterfaceData.db_password=response.result:console.log("Error decrypting password : "+response.message),dbInterfaceCtrl.dbInterfaceData.passwordDecrypt=!0})))})),!dbInterfaceCtrl.dbInterfaceData.passwordDecrypt&&dbInterfaceCtrl.dbInterfaceData.db_password&&""!=dbInterfaceCtrl.dbInterfaceData.db_password&&TDMService.decryptInterfacePassword({db_password:dbInterfaceCtrl.dbInterfaceData.db_password}).then((function(response){"FAILED"!=response.errorCode&&response.result?dbInterfaceCtrl.dbInterfaceData.db_password=response.result:console.log("Error decrypting password : "+response.message),dbInterfaceCtrl.dbInterfaceData.passwordDecrypt=!0})),dbInterfaceCtrl.interfaceType="1",null!=dbInterfaceCtrl.dbInterfaceData.db_connection_string&&(dbInterfaceCtrl.interfaceType="0"),dbInterfaceCtrl.disableChange=disableChange,dbInterfaceCtrl.saveDBInterface=function(){"1"==dbInterfaceCtrl.interfaceType?dbInterfaceCtrl.dbInterfaceData.db_connection_string=null:(dbInterfaceCtrl.dbInterfaceData.db_host=null,dbInterfaceCtrl.dbInterfaceData.db_port=null,dbInterfaceCtrl.dbInterfaceData.db_schema=null),0==dbInterfaceCtrl.dbInterfaceData.status&&(dbInterfaceCtrl.dbInterfaceData.newInterface=!0),dbInterfaceCtrl.dbInterfaceData.status=!0,dbInterfaceCtrl.dbInterfaceData.deleted=!1,$uibModalInstance.close(dbInterfaceCtrl.dbInterfaceData)},dbInterfaceCtrl.testDBInterfaceConn=function(){var requestData={interface_db_type:dbInterfaceCtrl.dbInterfaceData.interface_type,db_host:dbInterfaceCtrl.dbInterfaceData.db_host,db_port:dbInterfaceCtrl.dbInterfaceData.db_port,db_user:dbInterfaceCtrl.dbInterfaceData.db_user,db_password:dbInterfaceCtrl.dbInterfaceData.db_password,db_schema:dbInterfaceCtrl.dbInterfaceData.db_schema,db_connection_string:dbInterfaceCtrl.dbInterfaceData.db_connection_string};TDMService.testInterfaceDbConnection(requestData).then((function(response){"FAILED"!=response.errorCode&&response.result?(dbInterfaceCtrl.testDbConnSuccess=!0,dbInterfaceCtrl.testDBInterfaceConnResult="Success"):(dbInterfaceCtrl.testDbConnSuccess=!1,dbInterfaceCtrl.testDBInterfaceConnResult="Failed "+(response.message?"["+response.message+"]":"")),console.log("Connection Test Done.\n"+response.message)}))},dbInterfaceCtrl.close=function(){$uibModalInstance.close()}},controllerAs:"dbInterfaceCtrl"})},environmentCtrl.openNewProduct=function(){environmentCtrl.disableChangeProduct=!1,TDMService.getProductsWithLUs(environmentCtrl.environmentData.environment_id).then((function(response){if("SUCCESS"==response.errorCode){var allProducts=response.result;TDMService.getEnvProducts(environmentCtrl.environmentData.environment_id).then((function(response){var envProducts=response.result;"SUCCESS"==response.errorCode?environmentCtrl.newEnvProducts=_.reject(allProducts,(function(product){for(var i=0;i<envProducts.length;i++)if(envProducts[i].product_id===product.product_id&&"Active"===envProducts[i].status)return!0;return!1})):toastr.error("Environment # "+environmentCtrl.environmentData.environment_id,"Faild to get new systems")}))}else toastr.error("Environment # "+environmentCtrl.environmentData.environment_id,"Faild to get new systems")})),environmentCtrl.productData={},environmentCtrl.activityPanel="newProduct"},environmentCtrl.globalChanged=init=>{const chosenGlobal=_.find(environmentCtrl.newEnvGlobals,{globalName:environmentCtrl.globalData.global_name});chosenGlobal&&(environmentCtrl.globalLogicalUnits=chosenGlobal.luList,init||(environmentCtrl.globalData.luName=null,environmentCtrl.globalData.global_value=""))},environmentCtrl.globalLogicalUnitChanged=()=>{const chosenLogicalUnit=_.find(environmentCtrl.globalLogicalUnits,{luName:environmentCtrl.globalData.luName});chosenLogicalUnit&&(environmentCtrl.globalData.global_value=chosenLogicalUnit.defaultValue)},environmentCtrl.openNewGlobal=function(){environmentCtrl.disableChangeGlobal=!1,TDMService.getAllGlobals(null).then((function(response){var envGlobals=response.result;"SUCCESS"==response.errorCode?environmentCtrl.newEnvGlobals=_.filter(envGlobals,global=>_.findIndex(environmentCtrl.globals,{global_name:global.globalName})<0):toastr.error("Environment # "+environmentCtrl.environmentData.environment_id,"Faild to get new products")})),environmentCtrl.globalLogicalUnits=[],environmentCtrl.globalData={},environmentCtrl.activityPanel="newGlobal"},environmentCtrl.dataCenterChanged=function(){if(environmentCtrl.productData.data_center_name){var dataCenter=_.find(environmentCtrl.dataCenters,{dc:environmentCtrl.productData.data_center_name});if(dataCenter&&(environmentCtrl.addProductWarning=null,environmentCtrl.logicalUnitsForProduct))for(var i=0;i<environmentCtrl.logicalUnitsForProduct.length;i++)if(environmentCtrl.logicalUnitsForProduct[i].lu_dc_name&&""!=environmentCtrl.logicalUnitsForProduct[i].lu_dc_name&&environmentCtrl.logicalUnitsForProduct[i].lu_dc_name!==dataCenter.dc){environmentCtrl.addProductWarning={dc_name:dataCenter.dc,lu_name:environmentCtrl.logicalUnitsForProduct[i].lu_name,lu_dc_name:environmentCtrl.logicalUnitsForProduct[i].lu_dc_name};break}}},environmentCtrl.productChanged=function(){if(environmentCtrl.productData.product_id){TDMService.getProductLogicalUnits(environmentCtrl.productData.product_id).then((function(response){environmentCtrl.logicalUnitsForProduct=response.result,environmentCtrl.dataCenterChanged()}));var product=_.find(environmentCtrl.newEnvProducts,{product_id:environmentCtrl.productData.product_id});product&&(environmentCtrl.productData.product_versions=product.product_versions),environmentCtrl.productData.lus=parseInt(product.lus)}},environmentCtrl.addProduct=function(){1!=environmentCtrl.addProductInProgress&&(environmentCtrl.addProductInProgress=!0,environmentCtrl.productData&&environmentCtrl.productData.interfaces&&_.remove(environmentCtrl.productData.interfaces,{deleted:!0}),TDMService.postEnvProduct(environmentCtrl.environmentData.environment_id,environmentCtrl.environmentData.environment_name,environmentCtrl.productData).then((function(response){"SUCCESS"==response.errorCode?(toastr.success("System # "+environmentCtrl.productData.product_id,"Created Successfully"),TDMService.getEnvProducts(environmentCtrl.environmentData.environment_id).then((function(response){"SUCCESS"==response.errorCode&&(environmentCtrl.products=response.result,environmentCtrl.dtInstanceProducts.reloadData((function(data){}),!0))})),environmentCtrl.addProductInProgress=!1,environmentCtrl.getSummaryData()):(environmentCtrl.addProductInProgress=!1,toastr.error("System # "+environmentCtrl.productData.product_id,"Unable to Create : "+response.message))})))},environmentCtrl.openProductFullView=function(){environmentCtrl.productDataFullView={product_id:environmentCtrl.productData.product_id,product_name:environmentCtrl.productData.product_name,product_status:environmentCtrl.productData.product_status,product_vendor:environmentCtrl.productData.product_vendor,product_versions:environmentCtrl.productData.product_versions,product_description:environmentCtrl.productData.product_description},$scope.content.openProduct(environmentCtrl.productDataFullView)}},controllerAs:"environmentCtrl"}}angular.module("TDM-FE").directive("environmentDirective",environmentDirective);